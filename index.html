<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØªØ¨Ø¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØµÙˆØªÙŠØ©</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
</head>
<body>
    <section class="hero is-primary is-bold">
        <div class="hero-body">
            <div class="container">
                <h1 class="title">Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØµÙˆØªÙŠØ©</h1>
            </div>
        </div>
    </section>

    <form id="form" class="container m-4 pl-4" method="POST">
        <div class="field">
            <label class="label">Ø§Ù„ÙˆØµÙ</label>
            <div class="control">
                <input class="input" type="text" placeholder="Ø§Ù„ÙˆØµÙ" name="disc" id="disc">
            </div>
        </div>
        <div class="field">
            <label class="label">Ø§Ù„Ù†ÙˆØ¹</label>
            <div class="control">
                <input class="input" type="text" placeholder="Ø§Ù„Ù†ÙˆØ¹" name="category" id="category">
            </div>
        </div>
        <div class="field">
            <label class="label">Ø§Ù„Ø³Ø¹Ø±</label>
            <div class="control">
                <input class="input" type="text" placeholder="Ø§Ù„Ø³Ø¹Ø±" name="amount" id="amount">
            </div>
        </div>
        <div class="field">
            <label class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <div class="control">
                <input class="input" type="date" placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡" name="Date" id="Date">
            </div>
        </div>
        <div class="field">
            <label class="label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
            <div class="control">
                <label class="radio">
                    <input type="radio" name="payment" value="STC" id="bank1"> STC
                </label>
                <label class="radio">
                    <input type="radio" name="payment" value="SNB" id="bank2"> SNB
                </label>
                <label class="radio">
                    <input type="radio" name="payment" value="ÙƒØ§Ø´" id="cash"> ÙƒØ§Ø´
                </label>
            </div>
        </div>
        <div class="field">
            <label class="label">ØºÙŠØ± Ù…Ø®Ø·Ø· Ù„Ù‡</label>
            <div class="control">
                <label class="checkbox">
                    <input type="checkbox" name="unexpected" id="unexpected"> Ù†Ø¹Ù…
                </label>
            </div>
        </div>
        <div class="field is-grouped">
            <div class="control">
                <button class="button is-info" type="button" onclick="startListening()">ğŸ¤ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹</button>
            </div>
            <div class="control">
                <button class="button is-primary" type="submit" id="submit-button">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
            <div class="control">
                <button class="button is-danger" type="button">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </form>

    <div id="message" style="display: none; margin: 20px; font-weight: bold; color: green; padding: 8px; background-color: beige; border-radius: 4px; border-color: aquamarine;"></div>

    <script>
        function startListening() {
            if (!('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
                alert('Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.');
                return;
            }

            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'ar-SA';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('message').textContent = 'Ø³Ù…Ø¹Øª: ' + transcript;
                document.getElementById('message').style.display = 'block';
                parseAndFillForm(transcript);
            };

            recognition.onerror = function(event) {
                console.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + event.error);
            };

            recognition.start();
        }

        function parseAndFillForm(transcript) {
    // Ù‚Ù… Ø¨ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„ØªÙŠ Ù‚Ø¯ ØªØªÙˆÙ‚Ø¹Ù‡Ø§
    const amountPattern = /(\d+)\s*Ø±ÙŠØ§Ù„/;  // Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø¨Ø§Ù„Øº
    const categoryPattern = /(Ù†ÙˆØ¹|Ø§Ù„Ø§Ø¬Ø¨Ø§Ù†|Ø§Ù„Ø®Ø¨Ø²|Ø§Ù„Ø®Ø¶Ø§Ø±|Ø§Ù„ÙØ§ÙƒÙ‡Ø©|Ø§Ù„Ù„Ø­ÙˆÙ…)/; // ØªØµÙ†ÙŠÙØ§Øª Ù…Ø®ØªÙ„ÙØ© ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©
    const paymentPattern = /(STC|SNB|ÙƒØ§Ø´)/; // Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹
    const unexpectedPattern = /(ØºÙŠØ± Ù…Ø®Ø·Ø· Ù„Ù‡|Ù…ÙØ§Ø¬Ø¦)/; // Ø­Ø§Ù„Ø© ØºÙŠØ± Ø§Ù„Ù…Ø®Ø·Ø· Ù„Ù‡Ø§

    const amountMatch = transcript.match(amountPattern);
    const categoryMatch = transcript.match(categoryPattern);
    const paymentMatch = transcript.match(paymentPattern);
    const unexpectedMatch = transcript.match(unexpectedPattern);

    if (amountMatch) {
        document.getElementById('amount').value = amountMatch[1];
    }
    if (categoryMatch) {
        document.getElementById('category').value = categoryMatch[0];
    }
    if (paymentMatch) {
        document.getElementById(paymentMatch[0]).checked = true;
    }
    if (unexpectedMatch) {
        document.getElementById('unexpected').checked = true;
    }

    // ØªØ¹ÙŠÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ø¥Ø°Ø§ Ø°ÙƒØ± ÙÙŠ Ø§Ù„Ù†Øµ
    if (transcript.includes("Ø§Ù„ÙŠÙˆÙ…")) {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('Date').value = today;
    }

    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØµÙ Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
    const description = transcript.replace(amountPattern, '')
                                  .replace(categoryPattern, '')
                                  .replace(paymentPattern, '')
                                  .replace(unexpectedPattern, '')
                                  .replace('Ø§Ù„ÙŠÙˆÙ…', '') // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„Ù…Ø© "Ø§Ù„ÙŠÙˆÙ…" Ù…Ù† Ø§Ù„ÙˆØµÙ
                                  .trim();
    document.getElementById('disc').value = description;
}


        
        document.getElementById("form").addEventListener("submit", function (e) {
            e.preventDefault();
            document.getElementById("message").textContent = "Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";
            document.getElementById("message").style.display = "block";
            document.getElementById("submit-button").disabled = true;

            var formData = new FormData(this);
            var keyValuePairs = [];
            for (var pair of formData.entries()) {
              keyValuePairs.push(pair[0] + "=" + pair[1]);
            }

            var formDataString = keyValuePairs.join("&");

            fetch("https://script.google.com/macros/s/AKfycbzFqfs_PLLDG61SYSWhXmmWnAPxi9fhu2RYJhyVxJ1YCgNb1pkubmUM9RVJB9O3AbMH/exec", {
                redirect: "follow",
                method: "POST",
                body: formDataString,
                headers: {
                  "Content-Type": "text/plain;charset=utf-8",
                },
            })
            .then(function (response) {
                if (response) {
                    return response;
                } else {
                    throw new Error("ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.");
                }
            })
            .then(function (data) {
                document.getElementById("message").textContent = "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!";
                document.getElementById("message").style.display = "block";
                document.getElementById("message").style.backgroundColor = "green";
                document.getElementId("message").style.color = "beige";
                document.getElementById("submit-button").disabled = false;
                document.getElementById("form").reset();

                setTimeout(function () {
                  document.getElementById("message").textContent = "";
                  document.getElementById("message").style.display = "none";
                }, 2600);
            })
            .catch(function (error) {
                console.error(error);
                document.getElementById("message").textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.";
                document.getElementById("message").style.display = "block";
            });
        });
    </script>
</body>
</html>
